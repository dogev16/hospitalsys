{% extends "base.html" %}
{% load static %}

{% block title %}è™•æ–¹é–‹ç«‹ / ç·¨è¼¯{% endblock %}

{% block content %}
<div class="page-shell">

    <!-- é é¢æ¨™é¡Œ -->
    <div class="page-header">
        <div>
            <h1 class="page-title">è™•æ–¹é–‹ç«‹ / ç·¨è¼¯</h1>
            <p class="page-subtitle">
                ç—…äººï¼š
                {% if ticket %}
                    {{ ticket.patient.chart_no }} {{ ticket.patient.full_name }}
                {% else %}
                    {{ prescription.patient.chart_no }} {{ prescription.patient.full_name }}
                {% endif %}
                <span class="separator-dot"></span>
                çœ‹è¨ºæ—¥æœŸï¼š
                {% if ticket %}
                    {{ ticket.date }}
                {% else %}
                    {{ prescription.date }}
                {% endif %}
                <span class="separator-dot"></span>
                é†«å¸«ï¼š
                {% if ticket %}
                    {{ ticket.doctor.user.get_full_name }} / {{ ticket.doctor.department }}
                {% else %}
                    {{ prescription.doctor.user.get_full_name }} / {{ prescription.doctor.department }}
                {% endif %}
            </p>
        </div>

        <div class="toolbar-actions">
            {% if ticket %}
                <a href="{% url 'queues:doctor_panel' %}" class="btn btn-outline btn-sm">
                    è¿”å›å€™è¨ºåˆ—è¡¨
                </a>
            {% else %}
                <a href="{% url 'prescriptions:doctor_prescription_list' %}" class="btn btn-outline btn-sm">
                    è¿”å›è™•æ–¹æ­·å²
                </a>
            {% endif %}
        </div>
    </div>

    <!-- ç³»çµ±è¨Šæ¯ -->
    {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} mb-2">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {# ğŸ†• è‹¥è™•æ–¹è¢«è—¥å¸«é€€å›ï¼Œé¡¯ç¤ºé†’ç›®æé†’  #}
    {% if prescription and prescription.verify_status == prescription.VERIFY_REJECTED %}
        <div class="alert alert-warning mb-3">
            <strong>âš  è—¥å¸«é€€å›è™•æ–¹ ï¼š</strong><br>
            {% if prescription.verify_note %}
                {{ prescription.verify_note }}
            {% else %}
                è—¥å¸«é€€å›æ­¤è™•æ–¹ï¼Œè«‹æª¢æŸ¥è—¥å“æˆ–åŠ‘é‡è¨­å®š ã€‚
            {% endif %}
        </div>
    {% endif %}

    {# ç—…äººè³‡è¨Šå¡ç‰‡ï¼šå„ªå…ˆç”¨ ticket.patientï¼Œæ²’æœ‰å°±ç”¨ prescription.patient   #}
    {% with p=ticket.patient|default:prescription.patient %}
    <div class="card mb-3">
        <div class="card-header card-header-between">
            <div class="card-title-sm">
                ç—…äººåŸºæœ¬è³‡æ–™
            </div>
            <div class="card-meta text-xs text-muted">
                ç—…æ­·è™Ÿï¼š{{ p.chart_no }}
                {% if p.created_at %}
                    <span class="separator-dot"></span>
                    å»ºç«‹æ–¼ï¼š{{ p.created_at|date:"Y-m-d H:i" }}
                {% endif %}
            </div>
        </div>

        <div class="card-body">

            <!-- ä¸ŠåŠéƒ¨ï¼šåŸºæœ¬è³‡è¨Š + è¯çµ¡è³‡è¨Š  -->
            <div class="patient-info-layout">

                <!-- å·¦æ¬„ï¼šåŸºæœ¬è³‡æ–™  -->
                <div class="patient-info-column">
                    <div class="patient-info-section-title">åŸºæœ¬è³‡æ–™</div>
                    <dl class="patient-info-list">
                        <div class="patient-info-row">
                            <dt>å§“å</dt>
                            <dd>{{ p.full_name }}</dd>
                        </div>

                        <div class="patient-info-row">
                            <dt>æ€§åˆ¥ / å¹´é½¡</dt>
                            <dd>
                                {{ p.get_gender_display|default:"-" }}
                                {% if p.age %}
                                    ï¼ˆç´„ {{ p.age }} æ­²ï¼‰
                                {% endif %}
                            </dd>
                        </div>

                        <div class="patient-info-row">
                            <dt>å‡ºç”Ÿæ—¥æœŸ</dt>
                            <dd>{{ p.birth_date|date:"Y-m-d"|default:"-" }}</dd>
                        </div>

                        <div class="patient-info-row">
                            <dt>åœ°å€</dt>
                            <dd>{{ p.address|default:"-" }}</dd>
                        </div>
                    </dl>
                </div>

                <!-- å³æ¬„ï¼šè¯çµ¡ / ç·Šæ€¥è¯çµ¡äºº  -->
                <div class="patient-info-column">
                    <div class="patient-info-section-title">è¯çµ¡è³‡è¨Š</div>
                    <dl class="patient-info-list">
                        <div class="patient-info-row">
                            <dt>è¯çµ¡é›»è©±</dt>
                            <dd>{{ p.phone|default:"-" }}</dd>
                        </div>

                        <div class="patient-info-row">
                            <dt>ç·Šæ€¥è¯çµ¡äºº</dt>
                            <dd>
                                {{ p.emergency_contact_name|default:"-" }}
                                {% if p.emergency_contact_phone %}
                                    ï¼ˆ{{ p.emergency_contact_phone }}ï¼‰
                                {% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>

            </div>

            <!-- ä¸‹åŠéƒ¨ï¼šé†«ç™‚é¢¨éšªå€å¡Š  -->
            <div class="patient-risk-layout">
                <div class="patient-info-section-title mb-1">é†«ç™‚é¢¨éšª / ç—…å²</div>

                <div class="patient-risk-grid">
                    <div class="patient-risk-item">
                        <div class="info-label">éæ•å²</div>
                        <div class="info-value text-danger">
                            {{ p.allergies|default:"ç„¡ç‰¹åˆ¥éæ•ç´€éŒ„" }}
                        </div>
                    </div>

                    <div class="patient-risk-item">
                        <div class="info-label">æ…¢æ€§ç–¾ç—… / é‡è¦ç—…å²</div>
                        <div class="info-value">
                            {{ p.chronic_diseases|default:"æœªå¡«å¯«" }}
                        </div>
                    </div>

                    <div class="patient-risk-item">
                        <div class="info-label">å®¶æ—ç—…å²</div>
                        <div class="info-value">
                            {{ p.family_disease_notes|default:"ç„¡å®¶æ—ç—…å²" }}
                        </div>
                    </div>

                    <div class="patient-risk-item">
                        <div class="info-label">å…¶ä»–é¢¨éšª</div>
                        <div class="info-value">
                            {{ p.other_risk_notes|default:"ç„¡" }}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    {% endwith %}

    <!-- è¡¨å–®å¡ç‰‡ -->
    <div class="card">
        <div class="card-header">
            <span class="card-title-sm">è™•æ–¹å…§å®¹ç·¨è¼¯</span>
        </div>

        <div class="card-body">

            <form method="post">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for err in form.non_field_errors %}
                            <div>{{ err }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                {% if items.non_form_errors %}
                    <div class="alert alert-danger">
                        {% for err in items.non_form_errors %}
                            <div>{{ err }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- é†«å¸«å‚™è¨» -->
                <label class="form-label fw-bold">é†«å¸«å‚™è¨»</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div class="form-error">{{ form.notes.errors }}</div>
                {% endif %}

                <!-- ç”¨è—¥é …ç›® -->
                <h3 class="section-title mt-4">ç”¨è—¥é …ç›®</h3>

                {{ items.management_form }}

                <div class="table-container mt-2">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>è—¥å“</th>
                                <th style="width: 120px;">æ•¸é‡</th>
                                <th style="width: 120px;">ç”¨è—¥å¤©æ•¸</th>
                                <th style="width: 220px;">ç”¨æ³•</th>
                                <th style="width: 80px;">åˆªé™¤</th>
                                <td>
                                    {{ item_form.treatment_days }}
                                    {% if item_form.treatment_days.errors %}
                                        <div class="form-error">{{ item_form.treatment_days.errors }}</div>
                                    {% endif %}
                                </td>
                            </tr>
                        </thead>

                        <tbody>
                            {% for item_form in items %}
                                <tr>
                                    {% for hidden in item_form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}

                                    <td>
                                        {{ item_form.drug }}
                                        {% if item_form.drug.errors %}
                                            <div class="form-error">{{ item_form.drug.errors }}</div>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {{ item_form.quantity }}
                                        {% if item_form.quantity.errors %}
                                            <div class="form-error">{{ item_form.quantity.errors }}</div>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {{ item_form.treatment_days }}
                                        {% if item_form.treatment_days.errors %}
                                            <div class="form-error">{{ item_form.treatment_days.errors }}</div>
                                        {% endif %}
                                    </td>
                                    
                                    <td>
                                        {{ item_form.usage }}
                                        {% if item_form.usage.errors %}
                                            <div class="form-error">{{ item_form.usage.errors }}</div>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {% if item_form.instance.pk %}
                                            {{ item_form.DELETE }}
                                        {% endif %}
                                    </td>
                                    

                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="form-actions mt-4">
                    <button type="submit" class="btn btn-primary">å„²å­˜è™•æ–¹</button>

                    {% if ticket %}
                        <a href="{% url 'queues:doctor_panel' %}" class="btn btn-secondary">
                            å›å€™è¨ºåˆ—è¡¨
                        </a>
                    {% else %}
                        <a href="{% url 'prescriptions:doctor_prescription_list' %}" class="btn btn-secondary">
                            å›è™•æ–¹æ­·å²
                        </a>
                    {% endif %}
                </div>

            </form>

        </div>
    </div>

</div>
{% endblock %}
