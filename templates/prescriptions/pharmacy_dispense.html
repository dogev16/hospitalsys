{% extends "base.html" %}

{% block title %}處方領藥 - #{{ prescription.id }}{% endblock %}

{% block content %}

<div class="pharmacy-dispense-page">
    <div class="dispense-header">
        <h2>處方領藥 - #{{ prescription.id }}</h2>

        <div class="info-grid">
            <div><span class="info-label">病歷號：</span>{{ prescription.patient.chart_no|default:prescription.patient.id }}</div>
            <div><span class="info-label">病人姓名：</span>{{ prescription.patient.full_name }}</div>
            <div><span class="info-label">開立日期：</span>{{ prescription.date }}</div>
            <div><span class="info-label">醫師：</span>{{ prescription.doctor.user.get_full_name }} / {{ prescription.doctor.department }}</div>

            <div>
                <span class="info-label">藥師：</span>
                {% if prescription.dispensed_by %}
                    {{ prescription.dispensed_by.get_full_name }}
                {% else %}（尚未領藥）{% endif %}
            </div>

            <div>
                <span class="info-label">領藥時間：</span>
                {% if prescription.dispensed_at %}
                    {{ prescription.dispensed_at }}
                {% else %}（尚未領藥）{% endif %}
            </div>

            <div>
                <span class="info-label">醫師狀態：</span>
                <span class="status-pill status-success">
                    <span class="status-dot status-dot-ok"></span>
                    {{ prescription.get_status_display }}
                </span>
            </div>

            <div>
                <span class="info-label">藥局狀態：</span>

                {% if prescription.pharmacy_status == prescription.PHARMACY_DONE %}
                <span class="status-pill status-success">
                    <span class="status-dot status-dot-ok"></span>
                    {{ prescription.get_pharmacy_status_display }}
                </span>

                {% elif prescription.pharmacy_status == prescription.PHARMACY_PENDING %}
                <span class="status-pill status-warning">
                    <span class="status-dot status-dot-warn"></span>
                    {{ prescription.get_pharmacy_status_display }}
                </span>

                {% elif prescription.pharmacy_status == prescription.PHARMACY_CANCELLED %}
                <span class="status-pill status-danger">
                    <span class="status-dot status-dot-bad"></span>
                    {{ prescription.get_pharmacy_status_display }}
                </span>

                {% endif %}
            </div>
        </div>
    </div>

    <h4>醫師備註</h4>
    <div class="notes-box">
        {{ prescription.notes|default:"（無備註）" }}
    </div>

    <h4>用藥項目</h4>
    <table class="rx-items-table">
        <thead>
            <tr>
                <th>藥品</th>
                <th>數量</th>
                <th>用法</th>
                <th>目前庫存</th>
                <th>狀態</th>
            </tr>
        </thead>
        <tbody>
        {% for item in items %}
            <tr>
                <td>{{ item.drug.name }}</td>
                <td>{{ item.quantity }}</td>
                <td class="usage-col">{{ item.usage|linebreaksbr }}</td>
                <td>{{ item.drug.stock_quantity }}</td>
                <td>
                    {% if item.drug.stock_quantity >= item.quantity %}
                        <span class="stock-ok">庫存足夠</span>
                    {% else %}
                        <span class="stock-low">庫存不足！</span>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if has_shortage %}
    <div class="alert-text">部分藥品庫存不足，請先補貨或改藥後再領藥喵。</div>
    {% endif %}

    <div class="actions-row">
        {% if prescription.pharmacy_status == prescription.PHARMACY_PENDING %}
            <a href="{% url 'prescriptions:dispense_confirm' prescription.id %}"
               class="btn btn-primary {% if has_shortage %}btn-disabled{% endif %}">
                完成領藥
            </a>
        {% else %}
            <button class="btn btn-primary btn-disabled">已完成領藥</button>
        {% endif %}

        <a href="{% url 'prescriptions:pharmacy_panel' %}" class="btn btn-secondary">回藥局面板</a>
    </div>

    <form method="post"
          action="{% url 'prescriptions:cancel_or_return' prescription.id %}"
          class="actions-row"
          style="margin-top:10px;">
        {% csrf_token %}
        {% if prescription.pharmacy_status == prescription.PHARMACY_PENDING %}
            <button type="submit" class="btn btn-danger">作廢處方</button>
        {% elif prescription.pharmacy_status == prescription.PHARMACY_DONE %}
            <button type="submit" class="btn btn-warning">退藥並作廢</button>
        {% endif %}
    </form>

</div>

{% endblock %}
