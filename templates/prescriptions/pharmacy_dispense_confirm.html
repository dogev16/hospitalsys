{% extends "base.html" %}
{% load static %}

{% block title %}確認領藥 - #{{ prescription.id }}{% endblock %}

{% block content %}
<div class="page-shell">

  <div class="page-header">
    <div>
      <h1 class="page-title">確認完成領藥</h1>
      <p class="page-subtitle">
        處方編號：#{{ prescription.id }}，
        病人：{{ prescription.patient.full_name }}（{{ prescription.patient.chart_no|default:prescription.patient.id }}）
      </p>
    </div>

    <div class="toolbar-actions">
      <a href="{% url 'prescriptions:dispense' prescription.id %}"
         class="btn btn-outline btn-sm">
        返回處方領藥頁
      </a>
    </div>
  </div>

  <div class="card">
    <div class="card-header card-header-between">
      <div class="card-title-sm">
        領藥確認資訊
      </div>
      <div class="card-meta text-muted text-xs">
        狀態：{{ prescription.get_pharmacy_status_display }}
      </div>
    </div>

    <div class="card-body">
      <div class="info-grid mb-3">
        <div><span class="info-label">主治醫師：</span>{{ prescription.doctor.user.get_full_name|default:prescription.doctor.name }}</div>
        <div><span class="info-label">開立日期：</span>{{ prescription.date }}</div>
        <div><span class="info-label">目前登入藥師：</span>{{ request.user.get_full_name|default:request.user.username }}</div>
        <div><span class="info-label">醫師狀態：</span>{{ prescription.get_status_display }}</div>
      </div>

      <h4 class="section-title-sm">用藥項目</h4>

      <div class="table-container mb-3">
        <table class="table">
          <thead>
            <tr>
              <th>藥品</th>
              <th style="width:90px;">數量</th>
              <th style="width:120px;">目前庫存</th>
              <th style="width:140px;">可用狀態</th>
              <th>原因（若不可用）</th>
            </tr>
          </thead>
          <tbody>

            {# ✅ 改成用 checks（跟 view 的預檢查一致） #}
            {% for c in checks %}
              <tr>
                <td class="text-left">
                  {{ c.item.drug.name }}
                  <div class="text-muted text-xs">
                    代碼：{{ c.item.drug.code|default:"-" }}
                  </div>
                </td>
                <td>{{ c.item.quantity }}</td>
                <td>{{ c.item.drug.stock_quantity }}</td>

                <td>
                  {% if c.ok %}
                    <span class="tag tag-pill tag-verified">可發</span>
                  {% else %}
                    <span class="tag tag-pill tag-rejected">不可發</span>
                  {% endif %}
                </td>

                <td class="text-left">
                  {% if not c.ok %}
                    <div class="text-muted text-sm">{{ c.reason }}</div>
                    <div class="mt-1 d-flex flex-wrap gap-1">
                      <a class="btn btn-outline btn-sm"
                         href="{% url 'inventory:stock_history' %}?drug={{ c.item.drug.id }}"
                         target="_blank" rel="noopener noreferrer">
                        查庫存紀錄
                      </a>
                      <a class="btn btn-outline btn-sm"
                         href="{% url 'inventory:expiry_dashboard' %}"
                         target="_blank" rel="noopener noreferrer">
                        去效期管理
                      </a>
                    </div>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">尚未填寫用藥項目。</td>
              </tr>
            {% endfor %}

          </tbody>
        </table>
      </div>

      {% if has_shortage %}
        <div class="alert alert-warning text-sm mb-3">
          部分藥品<b>效期/庫存/狀態不符</b>，目前無法完成領藥 。
          {% if min_valid_days %}
            （政策：至少需可保存 {{ min_valid_days }} 天 ）
          {% endif %}
          請先補貨、解除隔離/報廢處理、或請醫師改藥後再回到此頁確認 。
        </div>
      {% else %}
        <p class="text-sm text-muted mb-3">
          請再次確認上述資訊無誤。按下「確認完成領藥」後，系統將扣減庫存並將此處方標記為「已領藥」 。
        </p>
      {% endif %}

      <form method="post" action="{% url 'prescriptions:dispense_confirm' prescription.id %}">
        {% csrf_token %}
        <div class="page-footer-actions">
          <a class="btn btn-outline-secondary"
             href="{% url 'prescriptions:pharmacy_panel' %}">
            取消 / 回藥局面板
          </a>

          <button type="submit"
                  class="btn btn-primary"
                  {% if has_shortage or prescription.pharmacy_status != prescription.PHARMACY_PENDING %}disabled{% endif %}>
            確認完成領藥
          </button>

          <a href="{% url 'prescriptions:prescription_print' prescription.id %}"
             class="btn btn-outline btn-sm"
             target="_blank"
             rel="noopener noreferrer">
            列印藥單
          </a>
        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}
