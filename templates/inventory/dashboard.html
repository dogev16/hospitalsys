{% extends "base.html" %}

{% block title %}Inventory Dashboard{% endblock %}

{% block sidebar %}
  <div class="app-side-title">功能選單</div>

  <div class="app-side-group">系統總覽</div>
  <a class="app-side-link" href="{% url 'public:home' %}">Dashboard</a>

  <div class="app-side-group">藥品與庫存</div>
  <a class="app-side-link is-active" href="{% url 'inventory:dashboard' %}">庫存總覽</a>
  <a class="app-side-link" href="{% url 'inventory:drug_list' %}">藥品清單</a>
  <a class="app-side-link" href="{% url 'inventory:stock_history' %}">進出庫紀錄</a>
{% endblock %}

{% block content %}

<div class="app-toolbar">
  <div>
    <div class="app-h1">Inventory Dashboard</div>
    <div class="app-subtitle">庫存概覽與近期異動</div>
  </div>

  <div class="app-toolbar-actions">
    <a class="app-btn app-btn-secondary" href="{% url 'inventory:drug_list' %}">Manage Drugs</a>
    <a class="app-btn app-btn-primary" href="{% url 'inventory:stock_history' %}">Stock History</a>
  </div>
</div>

<!-- KPI -->
<div class="app-grid app-grid-3">
  <div class="app-card app-kpi">
    <div class="app-kpi-label">Total Drugs</div>
    <div class="app-kpi-value">{{ total_drugs|default:0 }}</div>
    <div class="app-kpi-note">藥品總品項數量</div>
  </div>

  <div class="app-card app-kpi">
    <div class="app-kpi-label">Total Stock Quantity</div>
    <div class="app-kpi-value">{{ total_stock_quantity|default:0 }}</div>
    <div class="app-kpi-note">所有藥品「未過期批次」的庫存總和</div>
  </div>

  <div class="app-card app-kpi">
    <div class="app-kpi-label">Low Stock Drugs</div>
    <div class="app-kpi-value">{{ low_stock_count|default:0 }}</div>
    <div class="app-kpi-note">低於安全存量／需補貨的藥品</div>
  </div>
</div>

<!-- Low stock list -->
<section class="app-card app-section" style="margin-top:14px;">
  <div class="app-section-head">
    <div>
      <div class="app-section-title">Low Stock / Near Reorder Level</div>
      <div class="app-section-help">需要補貨注意名單</div>
    </div>
  </div>

  {% if low_stock_drugs %}
    <div class="app-table-wrap">
      <table class="app-table">
        <thead>
          <tr>
            <th>Drug</th>
            <th>Available (non-expired)</th>
            <th>Reorder Level</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for d in low_stock_drugs %}
            <tr>
              <td>
                <a class="app-link"
                   href="{% url 'inventory:stock_history' %}?drug={{ d.id }}">
                  {{ d.name }}
                </a>
              </td>

              <td>
                {% if d.non_expired_quantity <= 0 %}
                  <span class="app-badge app-badge-out">0</span>
                {% else %}
                  {{ d.non_expired_quantity }}
                {% endif %}
              </td>

              <td>{{ d.reorder_level }}</td>

              <td>
                {% if d.non_expired_quantity <= 0 %}
                  <span class="app-badge app-badge-out">Out of stock</span>
                {% else %}
                  <span class="app-badge app-badge-warn">Low stock</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="app-muted">No low-stock drugs right now.</div>
  {% endif %}
</section>

<!-- Recent transactions -->
<section class="app-card app-section">
  <div class="app-section-head">
    <div>
      <div class="app-section-title">Recent Transactions</div>
      <div class="app-section-help">最近 10 筆</div>
    </div>
  </div>

  {% if recent_transactions %}
    <div class="app-table-wrap">
      <table class="app-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Drug</th>
            <th>Qty</th>
            <th>Reason</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in recent_transactions %}
            <tr>
              <td>{{ tx.created_at|date:"Y-m-d H:i" }}</td>
              <td>{{ tx.drug }}</td>
              <td>
                {% if tx.change > 0 %}
                  <span style="color:#16a34a; font-weight:600;">+{{ tx.change }}</span>
                {% elif tx.change < 0 %}
                  <span style="color:#dc2626; font-weight:600;">{{ tx.change }}</span>
                {% else %}
                  <span style="color:#6b7280;">0</span>
                {% endif %}
              </td>
              <td>{{ tx.get_reason_display }}</td>
              <td>{{ tx.note }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="app-muted">No transactions yet.</div>
  {% endif %}
</section>

{% endblock %}

