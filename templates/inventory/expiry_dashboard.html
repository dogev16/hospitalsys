{% extends "base.html" %}

{% block title %}è—¥å“æ•ˆæœŸç®¡ç†{% endblock %}

{% block content %}
<div class="page-shell">

  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header">
    <div>
      <h1 class="page-title">è—¥å“æ•ˆæœŸç®¡ç†</h1>
      <p class="page-subtitle">
        ä»Šå¤©æ—¥æœŸï¼š{{ today|date:"Y-m-d" }}
        <span class="separator-dot"></span>
        é¡¯ç¤ºæ‰€æœ‰å·²éæœŸèˆ‡ {{ warning_days }} å¤©å…§å³å°‡åˆ°æœŸçš„æ‰¹æ¬¡ ã€‚
      </p>
    </div>
    

    <div class="toolbar-actions">
      <a href="{% url 'inventory:drug_list' %}" class="btn btn-outline btn-sm">
        è¿”å›è—¥å“æ¸…å–®
      </a>
      <a href="{% url 'inventory:quarantine_dashboard' %}" class="btn btn-outline btn-sm">
        éš”é›¢åº«å­˜
      </a>
    </div>
  </div>

  <div class="row g-2 mb-3">
    <div class="col-md-4">
      <div class="card shadow-sm"><div class="card-body">
        <div class="text-muted small">å·²éæœŸæ‰¹æ¬¡</div>
        <div class="h4 mb-0">{{ expired_count }}</div>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm"><div class="card-body">
        <div class="text-muted small">å³å°‡åˆ°æœŸæ‰¹æ¬¡</div>
        <div class="h4 mb-0">{{ near_expiry_count }}</div>
      </div></div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm"><div class="card-body">
        <div class="text-muted small">éš”é›¢æ‰¹æ¬¡</div>
        <div class="h4 mb-0">{{ quarantine_count }}</div>
      </div></div>
    </div>
  </div>
  <!-- ç³»çµ±è¨Šæ¯ï¼ˆmessagesï¼‰ -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ğŸ”´ å·²éæœŸæ‰¹æ¬¡ -->
  <div class="card mb-4">
    <div class="card-header card-header-flex">
      <div class="card-title-sm">
        å·²éæœŸæ‰¹æ¬¡ï¼ˆä¸å¾—å†ç™¼è—¥ï¼‰
      </div>
      <div class="card-meta text-xs text-muted">
        åªé¡¯ç¤ºã€Œæ•ˆæœŸ < ä»Šå¤©ã€ä¸”ã€Œå°šæœ‰åº«å­˜ã€çš„æ‰¹æ¬¡ ã€‚
      </div>
    </div>

    <div class="card-body">
      {% if expired_batches %}
        <div class="table-container">
          <table class="table table-hospital">
            <thead>
              <tr>
                <th style="width: 140px;">è—¥å“ä»£ç¢¼</th>
                <th>è—¥å“åç¨±</th>
                <th style="width: 120px;">æ‰¹è™Ÿ</th>
                <th style="width: 120px;">æ•ˆæœŸ</th>
                <th style="width: 110px;">å‰©é¤˜åº«å­˜</th>
                <th style="width: 180px;">å»ºè­°è™•ç†</th>
                <th style="width: 140px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for b in expired_batches %}
                <tr class="row-expired">
                  <td>{{ b.drug.code }}</td>
                  <td>{{ b.drug.name }}</td>
                  <td>{{ b.batch_no|default:"-" }}</td>
                  <td>{{ b.expiry_date|date:"Y-m-d" }}</td>
                  <td>{{ b.quantity }}</td>
                  <td>
                    <span class="badge-status badge-status-danger">å·²éæœŸ</span>
                    <span class="text-muted-small d-block">
                      å»ºè­°ï¼šåœæ­¢ç™¼è—¥ã€æ¨™è¨˜å ±å»¢æˆ–é€€è²¨ ã€‚
                    </span>
                  </td>
                  <!-- âœ… é€™æ ¼å°±æ˜¯ã€Œæ“ä½œã€ -->
                  <td>
                    <form method="post" action="{% url 'inventory:batch_destroy' b.id %}" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="quantity" value="{{ b.quantity }}">
                      <button class="btn btn-danger btn-sm" type="submit"
                              onclick="return confirm('ç¢ºå®šè¦æ•´æ‰¹å ±å»¢/éŠ·æ¯€å—ï¼Ÿ ')">
                        æ•´æ‰¹éŠ·æ¯€
                      </button>
                    </form>
                  </td>

                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted-small mb-0">
          ç›®å‰æ²’æœ‰å·²éæœŸä¸”å°šæœ‰åº«å­˜çš„æ‰¹æ¬¡ ï¼Œå¤ªæ£’äº† ï¼
        </p>
      {% endif %}
    </div>
  </div>

  <!-- ğŸŸ¡ å³å°‡åˆ°æœŸæ‰¹æ¬¡ -->
  <div class="card mb-4">
    <div class="card-header card-header-flex">
      <div class="card-title-sm">
        {{ warning_days }} å¤©å…§å³å°‡åˆ°æœŸçš„æ‰¹æ¬¡
      </div>
      <div class="card-meta text-xs text-muted">
        å”åŠ©è—¥å¸«å„ªå…ˆç™¼è—¥èˆ‡æ§ç®¡é€²è²¨ç¯€å¥ ã€‚
      </div>
    </div>

    <div class="card-body">
      {% if near_expiry_batches %}
        <div class="table-container">
          <table class="table table-hospital">
            <thead>
              <tr>
                <th style="width: 140px;">è—¥å“ä»£ç¢¼</th>
                <th>è—¥å“åç¨±</th>
                <th style="width: 120px;">æ‰¹è™Ÿ</th>
                <th style="width: 120px;">æ•ˆæœŸ</th>
                <th style="width: 110px;">å‰©é¤˜åº«å­˜</th>
                <th style="width: 180px;">æé†’</th>
                <th style="width: 140px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for b in near_expiry_batches %}
                <tr class="row-warning">
                  <td>{{ b.drug.code }}</td>
                  <td>{{ b.drug.name }}</td>
                  <td>{{ b.batch_no|default:"-" }}</td>
                  <td>{{ b.expiry_date|date:"Y-m-d" }}</td>
                  <td>{{ b.quantity }}</td>
                  <td>
                    <span class="badge-status badge-status-warning">å³å°‡åˆ°æœŸ</span>
                    <span class="text-muted-small d-block">
                      å»ºè­°ï¼šå„ªå…ˆç™¼è—¥ã€è©•ä¼°æ˜¯å¦æ¸›å°‘é€²è²¨ ã€‚
                    </span>
                  </td>

                  <!-- âœ… æ–°å¢ï¼šæ“ä½œï¼ˆéš”é›¢ï¼‰ -->
                  <td>
                    <form method="post" action="{% url 'inventory:batch_quarantine' b.id %}" class="d-flex gap-1 align-items-center">
                      {% csrf_token %}
                      <input type="hidden" name="reason" value="near_expiry">
                      <input type="hidden" name="note" value="å³å°‡åˆ°æœŸæ‰‹å‹•éš”é›¢">

                      <button class="btn btn-outline btn-sm" type="submit"
                              onclick="return confirm('ç¢ºå®šè¦éš”é›¢æ­¤æ‰¹æ¬¡å—ï¼Ÿ ')">
                        éš”é›¢
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted-small mb-0">
          ç›®å‰æ²’æœ‰ {{ warning_days }} å¤©å…§å³å°‡åˆ°æœŸçš„åº«å­˜ ã€‚
        </p>
      {% endif %}
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header card-header-flex">
      <div class="card-title-sm">å¿«é€Ÿæœå°‹æ‰¹æ¬¡ï¼ˆå¯éš”é›¢ï¼‰</div>
      <div class="card-meta text-xs text-muted">è¼¸å…¥è—¥å“ä»£ç¢¼ / åç¨± / æ‰¹è™Ÿï¼Œæ‰¾åˆ°å¾Œæ‰‹å‹•éš”é›¢ ã€‚</div>
    </div>

    <div class="card-body">
      <form method="get" class="d-flex gap-2 mb-3">
        <input name="q" class="form-control form-control-sm"
              placeholder="æœå°‹ï¼šä»£ç¢¼ / åç¨± / æ‰¹è™Ÿ" value="{{ q|default:'' }}">
        <button class="btn btn-outline btn-sm" type="submit">æœå°‹</button>
        <a class="btn btn-outline btn-sm" href="{% url 'inventory:expiry_dashboard' %}">æ¸…é™¤</a>
      </form>

      {% if search_batches %}
        <div class="table-container">
          <table class="table table-hospital">
            <thead>
              <tr>
                <th style="width: 140px;">è—¥å“ä»£ç¢¼</th>
                <th>è—¥å“åç¨±</th>
                <th style="width: 120px;">æ‰¹è™Ÿ</th>
                <th style="width: 120px;">æ•ˆæœŸ</th>
                <th style="width: 110px;">å‰©é¤˜åº«å­˜</th>
                <th style="width: 160px;">ç‹€æ…‹</th>
                <th style="width: 140px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {% for b in search_batches %}
              <tr>
                <td>{{ b.drug.code }}</td>
                <td>{{ b.drug.name }}</td>
                <td>{{ b.batch_no|default:"-" }}</td>
                <td>{{ b.expiry_date|date:"Y-m-d" }}</td>
                <td>{{ b.quantity }}</td>
                <td>
                  {% if b.status == b.STATUS_QUARANTINE %}
                    <span class="badge-status badge-status-warning">éš”é›¢ä¸­</span>
                  {% else %}
                    <span class="badge-status badge-status-ok">æ­£å¸¸</span>
                  {% endif %}
                </td>
                <td>
                  {% if b.status == b.STATUS_QUARANTINE %}
                    <span class="badge-status badge-status-warning">éš”é›¢ä¸­</span>
                    <a class="btn btn-outline btn-sm ms-2"
                      href="{% url 'inventory:quarantine_dashboard' %}">å»éš”é›¢é </a>
                  {% else %}
                    <form method="post"
                          action="{% url 'inventory:batch_quarantine' b.id %}"
                          class="d-flex flex-wrap gap-1 align-items-center">
                      {% csrf_token %}

                      {# âœ… æˆåŠŸå¾Œå›åˆ°åŒä¸€å€‹æœå°‹çµæœé ï¼ˆä¿ç•™ ?q=...ï¼‰ #}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">

                      <select name="reason" class="form-select form-select-sm" style="width: 140px;" required>
                        <option value="" selected disabled>åŸå› </option>
                        <option value="packaging">åŒ…è£ç•°å¸¸</option>
                        <option value="temperature">æº«æ§ç•°å¸¸</option>
                        <option value="recall">ç–‘ä¼¼å¬å›/æ‰¹æ¬¡å•é¡Œ</option>
                        <option value="source">ä¾†æº/æ–‡ä»¶ä¸é½Š</option>
                        <option value="other">å…¶ä»–</option>
                      </select>

                      <input name="note"
                            class="form-control form-control-sm"
                            style="min-width: 200px;"
                            placeholder="å‚™è¨»ï¼ˆå¿…å¡«ï¼‰"
                            required>

                      <button class="btn btn-outline btn-sm" type="submit"
                              onclick="return confirm('ç¢ºå®šè¦éš”é›¢æ­¤æ‰¹æ¬¡å—ï¼Ÿ ')">
                        éš”é›¢
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% elif q %}
        <div class="text-muted-small">æŸ¥ç„¡çµæœ ã€‚</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
