{% extends "base.html" %}
{% block title %}櫃台叫號面板{% endblock %}

{% block content %}
<div class="app-page">

    <div class="app-card">
        <div class="d-flex justify-content-between align-items-baseline mb-1">
            <div class="app-page-title">櫃台叫號面板</div>
            <div class="app-page-subtitle">
                今天日期：
                {% if tickets %}
                    {{ tickets.0.date|date:"Y-m-d" }}
                {% else %}
                    -
                {% endif %}
            </div>
        </div>

        <div class="mb-2 app-page-subtitle">
            顯示今天所有門診的叫號狀況，讓櫃台可以一眼看到目前進度。<br>
            狀態顏色：<strong>黃色＝目前叫號中</strong>、<strong>灰色＝已完成</strong>。
        </div>

        <div class="app-table-wrap">
            <table class="app-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>醫師</th>
                        <th>號碼</th>
                        <th>病人</th>
                        <th>狀態</th>
                        <th>建立時間</th>
                        <th>叫號時間</th>
                        <th>完成時間</th>
                    </tr>
                </thead>
                <tbody>
                    {% if tickets %}
                        {% for t in tickets %}
                            <tr class="status-{{ t.status|lower }}">
                                <td>{{ t.date }}</td>
                                <td>
                                    {{ t.doctor.name }}
                                    {% if t.doctor.department %}
                                        <br>
                                        <span style="font-size: 13px; color:#666;">
                                            {{ t.doctor.department }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ t.number }}</td>
                                <td>{{ t.patient }}</td>
                                <td>{{ t.get_status_display }}</td>
                                <td>{{ t.created_at|date:"H:i" }}</td>
                                <td>
                                    {% if t.called_at %}
                                        {{ t.called_at|date:"H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if t.finished_at %}
                                        {{ t.finished_at|date:"H:i" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8">今天還沒有任何叫號資料。</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <a href="{% url 'index' %}" class="btn btn-outline-secondary btn-sm">回首頁</a>
        </div>
    </div>
</div>

<script>
  (function () {
    const REFRESH_INTERVAL = 3000;
    let timerId = null;

    function startAutoRefresh() {
      if (timerId !== null) return;
      timerId = setInterval(function () {
        if (document.hidden) return;
        window.location.reload();
      }, REFRESH_INTERVAL);
    }

    function stopAutoRefresh() {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    startAutoRefresh();
    window.addEventListener("beforeunload", stopAutoRefresh);
  })();
</script>
{% endblock %}
