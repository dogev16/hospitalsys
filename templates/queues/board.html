{% extends "base.html" %}

{% block title %}é–€è¨ºçœ‹æ¿{% endblock %}

{% block content %}
<div class="page-wrapper">

  <div class="page-header mb-2">
    <h1 class="page-title">é–€è¨ºçœ‹æ¿</h1>
    <p class="page-subtitle text-muted">
      ä»Šå¤©æ—¥æœŸï¼š{{ today|date:"Y-m-d" }}<br>
      å³æ™‚é¡¯ç¤ºæ‰€æœ‰è¨ºé–“çš„å«è™Ÿç‹€æ³ ã€‚
    </p>
  </div>

  {# ğŸ”½ æ–°å¢ï¼šé¸æ“‡è¦çœ‹çš„é†«å¸«  #}
  <div class="mb-3 d-flex align-items-center gap-2">
    <form method="get" class="d-flex align-items-center gap-2">
      <label class="text-muted text-sm" for="doctor-select">é¡¯ç¤ºé†«å¸«ï¼š</label>
      <select id="doctor-select" name="doctor" class="form-select form-select-sm" style="max-width: 260px;">
        <option value="">å…¨éƒ¨é†«å¸«</option>
        {% for d in doctors %}
          <option value="{{ d.id }}"
                  {% if selected_doctor and selected_doctor.id == d.id %}selected{% endif %}>
            {{ d.name }}
            {% if d.department %} / {{ d.department }}{% endif %}
            {% if d.room %}ï¼ˆè¨ºé–“ï¼š{{ d.room }}ï¼‰{% endif %}
          </option>
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-sm btn-primary">
        åˆ‡æ›
      </button>
    </form>
  </div>

  {% if board_data %}
    <div class="board-grid">
      {% for row in board_data %}
        <div class="board-card">

          <!-- æ¨™é¡Œ -->
          <div class="board-card-header">
            <div class="board-doctor">
              {{ row.doctor.name }}
              {% if row.doctor.department %}
                <span class="tag tag-soft">{{ row.doctor.department }}</span>
              {% endif %}
              {% if row.doctor.room %}
                <span class="tag tag-outline">è¨ºé–“ï¼š{{ row.doctor.room }}</span>
              {% endif %}
            </div>
          </div>

          <div class="board-card-body">

            <div class="board-sections">

              <!-- ç›®å‰å«è™Ÿ -->
              <div class="board-section highlight-current">
                <div class="section-title">ç›®å‰å«è™Ÿ</div>
                {% if row.current %}
                  <div class="num-display current-num">#{{ row.current.number }}</div>
                  <div class="patient-name">
                    {{ row.current.patient.chart_no }} {{ row.current.patient.full_name }}
                  </div>
                  <div class="meta">
                    ç‹€æ…‹ï¼š{{ row.current.get_status_display }}<br>
                    å«è™Ÿï¼š{{ row.current.called_at|date:"H:i" }}
                  </div>
                {% else %}
                  <p class="text-muted mb-0">å°šç„¡å«è™Ÿã€‚</p>
                {% endif %}
              </div>

              <!-- ä¸‹ä¸€ä½ -->
              <div class="board-section highlight-next">
                <div class="section-title">ä¸‹ä¸€ä½</div>
                {% if row.next %}
                  <div class="num-display next-num">#{{ row.next.number }}</div>
                  <div class="patient-name">
                    {{ row.next.patient.chart_no }} {{ row.next.patient.full_name }}
                  </div>
                  <div class="meta">
                    ç‹€æ…‹ï¼š{{ row.next.get_status_display }}
                  </div>
                {% else %}
                  <p class="text-muted mb-0">æ²’æœ‰å€™è¨º ã€‚</p>
                {% endif %}
              </div>

              <!-- å·²å®Œæˆ -->
              <div class="board-section">
                <div class="section-title">æœ€è¿‘å®Œæˆ</div>

                {% if row.done %}
                  <ul class="done-list">
                    {% for t in row.done %}
                      <li>
                        <span class="done-num">#{{ t.number }}</span>
                        <span class="done-name">
                          {{ t.patient.chart_no }} {{ t.patient.full_name }}
                        </span>
                        <span class="done-time">
                          {{ t.finished_at|date:"H:i" }}
                        </span>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-muted mb-0">ç„¡å®Œæˆç´€éŒ„ã€‚</p>
                {% endif %}
              </div>

            </div>
          </div>

        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary text-center">
      ä»Šå¤©æ²’æœ‰ä»»ä½•å«è™Ÿç´€éŒ„ ã€‚
    </div>
  {% endif %}
</div>

<script>
  (function () {
    const REFRESH_INTERVAL_MS = 5000;
    setInterval(function () {
      if (!document.hidden) {
        window.location.reload();
      }
    }, REFRESH_INTERVAL_MS);
  })();
</script>

{% endblock %}
