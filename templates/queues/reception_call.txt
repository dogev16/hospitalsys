{% extends "base.html" %}

{% block content %}
<div class="queue-container">
    <h1 class="title">æ«ƒå°å«è™Ÿç³»çµ±</h1>

    <div class="today-box">
        <span>ğŸ“… ä»Šå¤©æ—¥æœŸï¼š<strong>{{ today }}</strong></span>
    </div>

    <!-- é¸æ“‡é†«å¸« -->
    <form method="get" class="doctor-selector">
        <label>ğŸ©º é¸æ“‡é†«å¸«ï¼š</label>
        <select name="doctor" onchange="this.form.submit()">
            {% for d in doctors %}
                <option value="{{ d.pk }}"
                    {% if selected_doctor and d.pk == selected_doctor.pk %}selected{% endif %}>
                    {{ d.name }}ï¼ˆ{{ d.department }}ï¼‰
                </option>
            {% endfor %}
        </select>
    </form>

    <!-- å«è™Ÿè³‡è¨Š -->
    <div class="current-ticket-box">
        {% if current_ticket %}
            <p>ğŸ”” ç›®å‰å«è™Ÿï¼š</p>
            <p class="big-number">ç¬¬ {{ current_ticket.number }} è™Ÿ</p>
            <p class="patient-name">{{ current_ticket.patient }}</p>

            <p class="status-tag status-{{ current_ticket.status|lower }}">
                ç‹€æ…‹ï¼š{{ current_ticket.status }}
            </p>
        {% else %}
            <p class="empty">ç›®å‰æ²’æœ‰å«è™Ÿä¸­çš„ç—…æ‚£ ã€‚</p>
        {% endif %}
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <form method="post" class="action-buttons">
        {% csrf_token %}
        {% if selected_doctor %}
            <input type="hidden" name="doctor" value="{{ selected_doctor.pk }}">
        {% endif %}

        <!-- é–‹å§‹ / ä¸‹ä¸€è™Ÿ -->
        <button type="submit" name="action" value="start_next" class="btn btn-next">
            â–¶ é–‹å§‹ / ä¸‹ä¸€è™Ÿ
        </button>

        <!-- é‡å«ä¸€æ¬¡ -->
        <button type="submit" name="action" value="repeat" class="btn btn-recall">
            ğŸ”„ é‡å«ä¸€æ¬¡
        </button>

        <!-- ğŸ†• éè™Ÿ + ä¸‹ä¸€è™Ÿ -->
        <button type="submit" name="action" value="skip" class="btn btn-skip">
            â­ éè™Ÿ + ä¸‹ä¸€è™Ÿ
        </button>
    </form>

    <!-- åˆ—è¡¨ -->
    <h2 class="subtitle">ä»Šæ—¥æ‰€æœ‰æ›è™Ÿï¼ˆ{{ selected_doctor.name }})</h2>

    <div class="table-container">
        <table class="styled-table">
            <thead>
                <tr>
                    <th>è™Ÿç¢¼</th>
                    <th>ç—…äºº</th>
                    <th>é ç´„æ™‚é–“</th>
                    <th>ç‹€æ…‹</th>
                    <th>å«è™Ÿæ™‚é–“</th>
                    <th>å®Œæˆæ™‚é–“</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tickets %}
                <tr class="row-{{ t.status|lower }}">
                    <td>{{ t.number }}</td>
                    <td>{{ t.patient }}</td>
                    <td>{{ t.appointment.time|default:"-" }}</td>
                    <td>{{ t.status }}</td>
                    <td>{{ t.called_at|default:"-" }}</td>
                    <td>{{ t.finished_at|default:"-" }}</td>
            
                    <!-- ğŸ†• æ“ä½œæ¬„ä½ -->
                    <td>
                        {% if t.status == "NO_SHOW" %}
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                {% if selected_doctor %}
                                    <input type="hidden" name="doctor" value="{{ selected_doctor.pk }}">
                                {% endif %}
                                <input type="hidden" name="ticket_id" value="{{ t.pk }}">
                                <button type="submit"
                                        name="action"
                                        value="recall_ticket"
                                       class="btn btn-small">
                                    å«å› 
                                </button>
                            </form>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="empty">ä»Šå¤©æ²’æœ‰æ›è™Ÿ ã€‚</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>

/* --- Layout å¤–æ¡† --- */
.queue-container {
    max-width: 900px;
    margin: auto;
    background: #ffffffdd;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 0 10px #00000022;
}

.title {
    text-align: center;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
}

/* --- æ—¥æœŸé¡¯ç¤º --- */
.today-box {
    padding: 10px 15px;
    background: #f0f7ff;
    border-left: 4px solid #2980b9;
    margin-bottom: 20px;
    font-size: 18px;
}

/* --- é†«å¸«é¸å–® --- */
.doctor-selector {
    margin-bottom: 25px;
    font-size: 18px;
}

.doctor-selector select {
    padding: 6px 12px;
    margin-left: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

/* --- ç›®å‰å«è™Ÿ --- */
.current-ticket-box {
    background: #fdf6e4;
    padding: 20px;
    border-radius: 10px;
    border-left: 5px solid #e67e22;
    margin-bottom: 25px;
}

.big-number {
    font-size: 42px;
    font-weight: bold;
    margin: 0;
}

.patient-name {
    font-size: 22px;
    margin: 5px 0;
}

.empty {
    color: #888;
}

.status-tag {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 14px;
    margin-top: 5px;
}

/* ç‹€æ…‹é¡è‰² */
.status-waiting { background: #dfe6e9; }
.status-calling { background: #ffeaa7; }
.status-done    { background: #badc58; }
.status-no_show { background: #ff7675; }

/* --- æ“ä½œæŒ‰éˆ• --- */
.action-buttons {
    text-align: center;
    margin-bottom: 30px;
}

.btn-next,
.btn-recall,
.btn-skip {
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 20px;
    border: none;
    cursor: pointer;
    margin-right: 10px;
}

/* ä¸‹ä¸€è™Ÿ */
.btn-next {
    background: #2980b9;
}
.btn-next:hover {
    background: #1f6390;
}

/* é‡å« */
.btn-recall {
    background: #7f8c8d;
}
.btn-recall:hover {
    background: #626c6d;
}

/* ğŸ†• éè™Ÿ + ä¸‹ä¸€è™Ÿ */
.btn-skip {
    background: #e67e22;
}
.btn-skip:hover {
    background: #cf7118;
}

/* --- è¡¨æ ¼æ¨£å¼ --- */
.table-container {
    overflow-x: auto;
}

.styled-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.styled-table th,
.styled-table td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}

/* å‹•æ…‹åˆ—èƒŒæ™¯ */
.row-calling  { background: #fff6d1; }
.row-done     { background: #e5ffd6; }
.row-waiting  { background: #f7f7f7; }
.row-no_show  { background: #ffe0e0; }

.btn-small {
    background: #3498db;
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 14px;
    border: none;
    cursor: pointer;
}

.btn-small:hover {
    background: #2176b5;
}

</style>
<script>
  (function () {
    const REFRESH_INTERVAL = 5000; // é€™è£¡æˆ‘å¹«ä½ è¨­ 5 ç§’ä¸€æ¬¡

    let timerId = null;

    function startAutoRefresh() {
      if (timerId !== null) return;
      timerId = setInterval(function () {
        if (document.hidden) return;
        window.location.reload();
      }, REFRESH_INTERVAL);
    }

    function stopAutoRefresh() {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    startAutoRefresh();
    window.addEventListener("beforeunload", stopAutoRefresh);
  })();
</script>
{% endblock %}
