{% extends "base.html" %}

{% block title %}æ«ƒå°å«è™Ÿç•«é¢å–µ{% endblock %}

{% block content %}
<style>
    .panel {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .current {
        background: #fff4c2;
        padding: 15px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .small-btn {
        padding: 6px 14px;
        margin-right: 8px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }
    th {
        background: #f2f5ff;
    }
    tr.done {
        background: #eee;
        color: #666;
    }
</style>

<h2>æ«ƒå°å«è™Ÿç•«é¢å–µ</h2>

<div class="panel">
  ä»Šå¤©æ—¥æœŸï¼š{{ today }}
</div>

<form method="get" class="panel">
  <label>é¸æ“‡é†«å¸«ï¼š</label>
  <select name="doctor" onchange="this.form.submit()">
    {% for d in doctors %}
      <option value="{{ d.pk }}" {% if selected_doctor and d.pk == selected_doctor.pk %}selected{% endif %}>
        {{ d.name }}ï¼ˆ{{ d.department }}ï¼‰
      </option>
    {% endfor %}
  </select>
</form>

{% if selected_doctor %}

  {% if current_ticket %}
    <div class="current">
      <div>ğŸš¨ ç›®å‰å«è™Ÿï¼šç¬¬ <strong>{{ current_ticket.number }}</strong> è™Ÿ</div>
      <div>ç—…äººï¼š{{ current_ticket.patient }}</div>
      <div>é–€è¨ºæ™‚é–“ï¼š{{ current_ticket.appointment.time }}</div>
      <div>å«è™Ÿæ™‚é–“ï¼š{{ current_ticket.called_at|date:"H:i" }}</div>

      <form method="post" style="margin-top: 10px;">
        {% csrf_token %}
        <button type="submit" name="action" value="recall" class="small-btn">ğŸ”Š é‡å«</button>
        <button type="submit" name="action" value="next"  class="small-btn">â¡ ä¸‹ä¸€è™Ÿ</button>
      </form>
    </div>
  {% else %}
    <div class="panel">
      ç›®å‰æ²’æœ‰å«è™Ÿä¸­çš„ç—…æ‚£å–µã€‚
      <form method="post" style="margin-top: 10px;">
        {% csrf_token %}
        <button type="submit" name="action" value="next" class="small-btn">é–‹å§‹å«è™Ÿ</button>
      </form>
    </div>
  {% endif %}

  <div class="panel">
    <h3>ä»Šæ—¥æ‰€æœ‰æ›è™Ÿï¼ˆ{{ selected_doctor.name }}ï¼‰</h3>

    <table>
      <thead>
        <tr>
          <th>è™Ÿç¢¼</th>
          <th>ç—…äºº</th>
          <th>é ç´„æ™‚é–“</th>
          <th>ç‹€æ…‹</th>
          <th>å«è™Ÿæ™‚é–“</th>
          <th>å®Œæˆæ™‚é–“</th>
        </tr>
      </thead>

      <tbody>
        {% for t in tickets %}
        <tr class="{{ t.status }}">
          <td>{{ t.number }}</td>
          <td>{{ t.patient }}</td>
          <td>{{ t.appointment.time }}</td>
          <td>{{ t.get_status_display }}</td>
          <td>{{ t.called_at|date:"H:i" }}</td>
          <td>{{ t.finished_at|date:"H:i" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6">ä»Šå¤©æ²’æœ‰æ›è™Ÿè³‡æ–™å–µã€‚</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

{% else %}
  <div class="panel">è«‹å…ˆé¸æ“‡é†«å¸«å–µã€‚</div>
{% endif %}

{% endblock %}
