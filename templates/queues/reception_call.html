{% extends "base.html" %}
{% block title %}æ«ƒå°å«è™Ÿç³»çµ±{% endblock %}

{% block content %}
<div class="app-page">

    <div class="app-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="app-page-title">æ«ƒå°å«è™Ÿç³»çµ±</div>
            <div class="app-page-subtitle">
                ğŸ“… ä»Šå¤©æ—¥æœŸï¼š<strong>{{ today }}</strong>
            </div>
        </div>

        <!-- é¸æ“‡é†«å¸« -->
        <form method="get" class="mb-3 d-flex align-items-center gap-2">
            <label class="mb-0">ğŸ©º é¸æ“‡é†«å¸«ï¼š</label>
            <select name="doctor" onchange="this.form.submit()" class="form-select form-select-sm" style="max-width: 260px;">
                {% for d in doctors %}
                    <option value="{{ d.pk }}"
                        {% if selected_doctor and d.pk == selected_doctor.pk %}selected{% endif %}>
                        {{ d.name }}ï¼ˆ{{ d.department }}ï¼‰
                    </option>
                {% endfor %}
            </select>
        </form>

        <!-- ç›®å‰å«è™Ÿ -->
        <div class="app-card" style="padding: 1rem 1.25rem;">
            {% if current_ticket %}
                <p class="mb-1 app-page-subtitle">ğŸ”” ç›®å‰å«è™Ÿï¼š</p>
                <p style="font-size: 2rem; font-weight: 700;" class="mb-1">
                    ç¬¬ {{ current_ticket.number }} è™Ÿ
                </p>
                <p style="font-size: 1.2rem;" class="mb-1">
                    {{ current_ticket.patient }}
                </p>

                <p class="mb-0">
                    <span class="app-status-tag app-status-{{ current_ticket.status|lower }}">
                        ç‹€æ…‹ï¼š{{ current_ticket.get_status_display|default:current_ticket.status }}
                    </span>
                </p>
            {% else %}
                <p class="text-muted mb-0">ç›®å‰æ²’æœ‰å«è™Ÿä¸­çš„ç—…æ‚£ã€‚</p>
            {% endif %}
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <form method="post" class="text-center mt-3">
            {% csrf_token %}
            {% if selected_doctor %}
                <input type="hidden" name="doctor" value="{{ selected_doctor.pk }}">
            {% endif %}

            <button type="submit" name="action" value="start_next" class="app-btn app-btn-primary">
                â–¶ é–‹å§‹ / ä¸‹ä¸€è™Ÿ
            </button>

            <button type="submit" name="action" value="repeat" class="app-btn app-btn-ghost">
                ğŸ”„ é‡å«ä¸€æ¬¡
            </button>

            <button type="submit" name="action" value="skip" class="app-btn app-btn-danger">
                â­ éè™Ÿ + ä¸‹ä¸€è™Ÿ
            </button>
        </form>
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="app-card">
        <div class="app-card-header">
            <div class="app-card-title">
                ä»Šæ—¥æ‰€æœ‰æ›è™Ÿï¼ˆ{{ selected_doctor.name }}ï¼‰
            </div>
        </div>

        <div class="app-table-wrap">
            <table class="app-table">
                <thead>
                    <tr>
                        <th>è™Ÿç¢¼</th>
                        <th>ç—…äºº</th>
                        <th>é ç´„æ™‚é–“</th>
                        <th>ç‹€æ…‹</th>
                        <th>å«è™Ÿæ™‚é–“</th>
                        <th>å®Œæˆæ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickets %}
                    <tr>
                        <td>{{ t.number }}</td>
                        <td>{{ t.patient }}</td>
                        <td>{{ t.appointment.time|default:"-" }}</td>
                        <td>
                            <span class="app-status-tag app-status-{{ t.status|lower }}">
                                {{ t.get_status_display|default:t.status }}
                            </span>
                        </td>
                        <td>{{ t.called_at|default:"-" }}</td>
                        <td>{{ t.finished_at|default:"-" }}</td>
                        <td>
                            {% if t.status == "NO_SHOW" %}
                                <form method="post" style="display:inline;">
                                    {% csrf_token %}
                                    {% if selected_doctor %}
                                        <input type="hidden" name="doctor" value="{{ selected_doctor.pk }}">
                                    {% endif %}
                                    <input type="hidden" name="ticket_id" value="{{ t.pk }}">
                                    <button type="submit"
                                            name="action"
                                            value="recall_ticket"
                                            class="app-btn app-btn-primary app-btn-sm">
                                        å«å›
                                    </button>
                                </form>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-muted">ä»Šå¤©æ²’æœ‰æ›è™Ÿã€‚</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
  (function () {
    const REFRESH_INTERVAL = 5000;
    let timerId = null;

    function startAutoRefresh() {
      if (timerId !== null) return;
      timerId = setInterval(function () {
        if (document.hidden) return;
        window.location.reload();
      }, REFRESH_INTERVAL);
    }

    function stopAutoRefresh() {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    startAutoRefresh();
    window.addEventListener("beforeunload", stopAutoRefresh);
  })();
</script>
{% endblock %}
