{% extends "base.html" %}

{% block title %}é†«å¸«é¢æ¿{% endblock %}

{% block content %}

<style>
    .panel-box {
        background: #f9f9ff;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 10px;
        color: #444;
    }

    table {
        width: 60%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th, td {
        border: 1px solid #ccc;
        padding: 6px 10px;
        text-align: center;
    }

    th {
        background: #f0f0f0;
    }

    .btn-call {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
        text-decoration: none;
        display: inline-block;
    }

    .btn-call:hover {
        background: #45a049;
    }

    .btn-finish {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
    }

    .btn-finish:hover {
        background: #c0392b;
    }

    .highlight-current {
        background-color: #fff2cc !important;
        font-weight: bold;
    }

    .btn-secondary-link {
        display: inline-block;
        margin-top: 10px;
        padding: 8px 16px;
        border-radius: 6px;
        border: 1px solid #888;
        text-decoration: none;
        color: #333;
        background: #f7f7f7;
        font-size: 14px;
    }

    .btn-secondary-link:hover {
        background: #ececec;
    }
</style>

<h1>é†«å¸«é¢æ¿å–µ</h1>

{# 1. é†«å¸«è³‡è¨Šå–µ #}
<div class="panel-box">
    {% if doctor %}
      <p>
        <strong>é†«å¸«ï¼š</strong>{{ doctor.name }}ã€€
        <strong>æ—¥æœŸï¼š</strong>{{ today }}
      </p>
    {% else %}
      <p style="color:red;">æ²’æœ‰å°æ‡‰çš„é†«å¸«è³‡æ–™å–µã€‚</p>
    {% endif %}
</div>

{# 2. ç›®å‰å«è™Ÿä¸­å–µ #}
<div class="panel-box">
    <div class="section-title">ç›®å‰å«è™Ÿä¸­å–µ</div>

    {% if current_ticket %}
        <p class="highlight-current">
            â–¶ ç¾åœ¨çœ‹è¨ºï¼š #{{ current_ticket.number }} â€” {{ current_ticket.patient.full_name }} å–µ
        </p>

        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="finish">
            <input type="hidden" name="ticket_id" value="{{ current_ticket.id }}">
            <button type="submit" class="btn-finish">æ­¤ç—…äººçœ‹è¨ºå®Œæˆå–µ</button>
        </form>

        {# é–‹ / ç·¨è¼¯è™•æ–¹æŒ‰éˆ•å–µ #}
        <div style="margin-top: 15px;">
            <a href="{% url 'prescriptions:edit_for_ticket' current_ticket.id %}"
               class="btn-call">
              ğŸ“ é–‹ç«‹ / ç·¨è¼¯è™•æ–¹å–µ
            </a>

            {% if current_ticket.prescription %}
              <span style="margin-left: 10px; font-size: 14px; color: #555;">
                ï¼ˆå·²æœ‰è™•æ–¹ï¼Œé»ä¸Šé¢å¯ä¿®æ”¹å–µï¼‰
              </span>
            {% endif %}
        </div>

    {% else %}
        <p>ç›®å‰æ²’æœ‰æ­£åœ¨çœ‹è¨ºçš„è™Ÿç¢¼å–µã€‚</p>

        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="call_next">
            <button type="submit" class="btn-call">å«ä¸‹ä¸€ä½å–µï¼</button>
        </form>
    {% endif %}
</div>

{# 3. ç­‰å¾…ä¸­ç—…äººå–µ #}
<div class="panel-box">
    <div class="section-title">ç­‰å¾…ä¸­ç—…äººå–µ</div>

    {% if waiting_tickets %}
      <table>
        <tr>
          <th>è™Ÿç¢¼</th>
          <th>æ™‚é–“</th>
          <th>ç—…äºº</th>
          <th>ç‹€æ…‹</th>
        </tr>
        {% for t in waiting_tickets %}
          <tr>
            <td>{{ t.number }}</td>
            <td>{{ t.appointment.time }}</td>
            <td>{{ t.appointment.patient.full_name }}</td>
            <td>{{ t.get_status_display }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>ç›®å‰æ²’æœ‰ç­‰å¾…ä¸­çš„ç—…äººå–µã€‚</p>
    {% endif %}
</div>

{# 4. ä»Šæ—¥å…¨éƒ¨æ›è™Ÿç—…äººå–µ #}
<div class="panel-box">
    <div class="section-title">ä»Šæ—¥å…¨éƒ¨æ›è™Ÿç—…äººå–µï¼ˆAppointmentï¼‰</div>

    {% if today_appointments %}
      <table>
        <tr>
          <th>æ™‚é–“</th>
          <th>ç—…æ­·è™Ÿ</th>
          <th>ç—…äººå§“å</th>
          <th>ç‹€æ…‹</th>
        </tr>

        {% for appt in today_appointments %}
          <tr {% if forloop.first %}class="highlight-current"{% endif %}>
            <td>{{ appt.time|time:"H:i" }}</td>
            <td>{{ appt.patient.chart_no }}</td>
            <td>{{ appt.patient.full_name }}</td>
            <td>{{ appt.get_status_display }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>ä»Šå¤©æ²’æœ‰æ›è™Ÿè³‡æ–™å–µã€‚</p>
    {% endif %}
</div>

{# 5. é†«å¸«è™•æ–¹ç›¸é—œåŠŸèƒ½å–µ #}
<div class="panel-box">
    <div class="section-title">è™•æ–¹ç›¸é—œåŠŸèƒ½å–µ</div>

    <p>æŸ¥çœ‹ä½ éå»ç‚ºç—…äººé–‹ç«‹çš„è™•æ–¹ç´€éŒ„å–µï¼Œå¯ä»¥ç”¨ä¾†è¿½è¹¤é•·æœŸç”¨è—¥æˆ–å¯«é†«å›‘å–µã€‚</p>

    <a href="{% url 'prescriptions:doctor_prescription_list' %}"
       class="btn-secondary-link">
        ğŸ“œ æŸ¥çœ‹è™•æ–¹æ­·å²å–µ
    </a>
</div>

{% endblock %}
