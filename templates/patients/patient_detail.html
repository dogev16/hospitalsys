{% extends "base.html" %}

{% block title %}ç—…äººè©³ç´°è³‡æ–™{% endblock %}

{% block content %}
<div class="page-wrap patient-detail">

  <!-- Header -->
  <div class="page-head patient-head">
    <div class="patient-head-left">
      <h1 class="page-title">ç—…äººè©³ç´°è³‡æ–™</h1>
      <div class="muted patient-meta">
        ç—…æ­·è™Ÿï¼š<strong class="mono">{{ patient.chart_no }}</strong>
        <span class="dot-sep">â€¢</span>
        å§“åï¼š<strong>{{ patient.full_name }}</strong>
      </div>
    </div>

    <div class="toolbar patient-actions">
      <a class="btn btn-secondary" href="{% url 'patients:patient_list' %}">â† å›ç—…äººåˆ—è¡¨</a>
      <a class="btn btn-outline" href="{% url 'patients:patient_update' patient.id %}">ç·¨è¼¯</a>
      <a class="btn btn-main" href="{% url 'appointments:new_for_patient' patient.id %}">ï¼‹ æ–°å¢æ›è™Ÿ</a>
    </div>
  </div>

  <!-- Top grid -->
  <div class="grid patient-grid">

    <!-- åŸºæœ¬è³‡æ–™ -->
    <section class="card patient-card">
      <div class="card-head">
        <h2 class="card-title">åŸºæœ¬è³‡æ–™</h2>
      </div>

      <table class="kv">
        <tr>
          <th>ç—…æ­·è™Ÿ</th>
          <td><strong class="mono">{{ patient.chart_no }}</strong></td>
        </tr>
        <tr>
          <th>å§“å</th>
          <td>{{ patient.full_name }}</td>
        </tr>
        <tr>
          <th>èº«åˆ†è­‰</th>
          <td class="mono">{{ patient.national_id }}</td>
        </tr>
        <tr>
          <th>é›»è©±</th>
          <td class="mono">{{ patient.phone }}</td>
        </tr>
        <tr>
          <th>ç”Ÿæ—¥</th>
          <td>{{ patient.birth_date }}</td>
        </tr>
        <tr>
          <th>æ€§åˆ¥</th>
          <td>{{ patient.gender|default:"â€”" }}</td>
        </tr>
        <tr>
          <th>è¡€å‹</th>
          <td>{{ patient.blood_type|default:"â€”" }}</td>
        </tr>
        <tr>
          <th>èº«é«˜ / é«”é‡</th>
          <td class="mono">
            {% if patient.height_cm %}{{ patient.height_cm }} cm{% else %}â€”{% endif %}
            /
            {% if patient.weight_kg %}{{ patient.weight_kg }} kg{% else %}â€”{% endif %}
          </td>
        </tr>
        <tr>
          <th>éæ•å²</th>
          <td>
            {% if patient.allergies %}
              {{ patient.allergies }}
            {% else %}
              <span class="muted">å°šæœªè¨˜éŒ„</span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>æ…¢æ€§ç—…</th>
          <td>
            {% if patient.chronic_diseases %}
              {{ patient.chronic_diseases }}
            {% else %}
              <span class="muted">å°šæœªè¨˜éŒ„</span>
            {% endif %}
          </td>
        </tr>
      </table>
    </section>

    <!-- å¿«é€Ÿè³‡è¨Š -->
    <aside class="card patient-card">
      <div class="card-head">
        <h2 class="card-title">å¿«é€Ÿè³‡è¨Š</h2>
      </div>

      <div class="chip-row">
        <span class="badge">ğŸ“Œ å…§éƒ¨ä½œæ¥­é é¢</span>
        <span class="badge warn">ğŸ§¾ å¯åœ¨ä¸‹æ–¹ç®¡ç†ç‹€æ…‹</span>
      </div>

      <div class="hint-list">
        <div class="hint-item">
          <span class="hint-icon">âœ…</span>
          <div class="hint-text">ã€Œå®Œæˆã€æœƒå°‡ç‹€æ…‹è¨­ç‚º <span class="mono">DONE</span></div>
        </div>
        <div class="hint-item">
          <span class="hint-icon">â›”</span>
          <div class="hint-text">ã€Œå–æ¶ˆã€æœƒå°‡ç‹€æ…‹è¨­ç‚º <span class="mono">CANCELLED</span></div>
        </div>
        <div class="hint-item">
          <span class="hint-icon">ğŸ“</span>
          <div class="hint-text">æ“ä½œå¾Œæœƒç•™åœ¨æ­¤é ï¼ˆä½¿ç”¨ <span class="mono">next</span> åƒæ•¸ï¼‰</div>
        </div>
      </div>
    </aside>

  </div>

  <!-- Appointments -->
  <section class="card patient-card">
    <div class="card-head card-head-between">
      <h2 class="card-title">æ›è™Ÿ / çœ‹è¨ºç´€éŒ„</h2>
      <div class="muted">
        {% if appointments %}å…± {{ appointments|length }} ç­†{% else %}ç›®å‰ 0 ç­†{% endif %}
      </div>
    </div>

    {% if appointments %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>æ™‚é–“</th>
              <th>é†«å¸«</th>
              <th>ç‹€æ…‹</th>
              <th class="col-actions">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for appt in appointments %}
              <tr>
                <td>{{ appt.date }}</td>
                <td class="mono">{{ appt.time|time:"H:i" }}</td>
                <td>{{ appt.doctor.name }}</td>
                <td>
                  {% if appt.status == "DONE" %}
                    <span class="badge ok">âœ… {{ appt.get_status_display }}</span>
                  {% elif appt.status == "CANCELLED" %}
                    <span class="badge bad">â›” {{ appt.get_status_display }}</span>
                  {% else %}
                    <span class="badge warn">â³ {{ appt.get_status_display }}</span>
                  {% endif %}
                </td>
                <td>
                  <div class="actions">
                    <form class="inline-form" method="post" action="{% url 'appointments:appointment_update_status' appt.pk %}">
                      {% csrf_token %}
                      <input type="hidden" name="status" value="DONE">
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <button class="btn btn-main btn-sm" type="submit">å®Œæˆ</button>
                    </form>

                    <form class="inline-form" method="post" action="{% url 'appointments:appointment_update_status' appt.pk %}">
                      {% csrf_token %}
                      <input type="hidden" name="status" value="CANCELLED">
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <button class="btn btn-danger btn-sm" type="submit">å–æ¶ˆ</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-emoji">ğŸ—‚ï¸</div>
        <div class="muted">ç›®å‰æ²’æœ‰æ›è™Ÿæˆ–çœ‹è¨ºç´€éŒ„ ï½</div>
      </div>
    {% endif %}
  </section>

</div>
{% endblock %}
